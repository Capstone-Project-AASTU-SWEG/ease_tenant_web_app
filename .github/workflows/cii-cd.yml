name: Ease Tenant CI/CD to EC2

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          # cache: 'npm'

      - name: ü•ü Install Bun
        run: |
          curl -fsSL https://bun.sh/install | bash
          echo "$HOME/.bun/bin" >> $GITHUB_PATH

      - name: üì• Install Dependencies
        run: |
          bun install
          bun add framer-motion

      # Optional: Run tests
      # - name: ‚úÖ Run Tests
      #   run: bun test

      - name: üèóÔ∏è Build Production Files
        run: bun run build

      - name: Clean up old build
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_INSTANCE_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üßπ Cleaning old .next build"
            rm -rf /home/ubuntu/kuraz-hub-client/.next

      - name: üì§ Copy Built Files to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_INSTANCE_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: |
            .next/
            public/
            package.json
            bun.lockb
          target: "/home/ubuntu/kuraz-hub-client/"

      - name: üöÄ Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_INSTANCE_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîÑ Deploying Next.js app..."
            cd /home/ubuntu/kuraz-hub-client
            if ! command -v bun &> /dev/null; then
              curl -fsSL https://bun.sh/install | bash
              export PATH="$HOME/.bun/bin:$PATH"
            fi
            bun install --production
            # Uncomment and edit the following line if using PM2 or another process manager:
            # pm2 restart next-app || pm2 start "bun run start" --name next-app --cwd /home/ubuntu/kuraz-hub-client
            echo "‚úÖ Next.js deployed successfully!"

      - name: üîç Verify Deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_INSTANCE_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            curl -I http://localhost || echo "Deployment verification completed!"